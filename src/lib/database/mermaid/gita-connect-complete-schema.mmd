erDiagram
    %% ========================================
    %% CLEAN DATA SEPARATION ARCHITECTURE
    %% ========================================
    %% Alumni Members (Source Data from CSV Uploads)
    ALUMNI_MEMBERS ||--o{ USERS : links_to
    ALUMNI_MEMBERS ||--o{ USER_PROFILES : provides_data_for

    %% App Users (Authenticated Platform Users)
    USERS ||--o{ USER_PROFILES : has
    USERS ||--o{ USER_INVITATIONS : invited_by
    USERS ||--o{ USER_SESSIONS : creates
    USERS ||--o{ AUDIT_LOGS : generates

    %% User Profiles (Extended Information)
    USER_PROFILES ||--o{ USER_PREFERENCES : has

    %% ========================================
    %% INVITATION & AUTHENTICATION RELATIONSHIPS
    %% ========================================

    %% Core Invitation Relationships
    USERS ||--o{ USER_INVITATIONS : invited_by
    USERS ||--o{ USER_INVITATIONS : accepted_by
    USER_INVITATIONS ||--o{ USERS : creates

    %% OTP System Relationships
    USERS ||--o{ OTP_TOKENS : generates
    OTP_TOKENS ||--o{ USERS : for_user

    %% Family Invitation Relationships
    USERS ||--o{ FAMILY_INVITATIONS : invited_by
    FAMILY_INVITATIONS ||--o{ USERS : creates_multiple

    %% COPPA Compliance Relationships
    USERS ||--o{ AGE_VERIFICATION : has
    USERS ||--o{ PARENT_CONSENT_RECORDS : child_in
    PARENT_CONSENT_RECORDS ||--o{ USERS : parent_consents_for

    %% Email & Audit Relationships
    USER_INVITATIONS ||--o{ EMAIL_DELIVERY_LOG : tracked_in
    OTP_TOKENS ||--o{ EMAIL_DELIVERY_LOG : tracked_in
    FAMILY_INVITATIONS ||--o{ EMAIL_DELIVERY_LOG : tracked_in
    USER_INVITATIONS ||--o{ INVITATION_AUDIT_LOG : audited_in

    %% ========================================
    %% LEGACY TABLES (TO BE MIGRATED)
    %% ========================================
    %% Note: These tables exist but are being phased out
    %% in favor of the clean separation above

    %% ========================================
    %% POSTINGS & CONTENT MANAGEMENT
    %% ========================================
    USERS ||--o{ POSTINGS : creates
    POSTINGS ||--o{ POSTING_ATTACHMENTS : contains
    POSTINGS ||--o{ POSTING_INTERESTS : receives
    POSTINGS ||--o{ POSTING_CATEGORIES : categorized_as
    POSTINGS ||--o{ POSTING_DOMAINS : belongs_to
    POSTINGS ||--o{ MODERATION_DECISIONS : reviewed_by
    POSTINGS ||--o{ AUDIT_LOGS : tracked_in

    %% Interest & Help Requests
    USERS ||--o{ POSTING_INTERESTS : expresses
    POSTING_INTERESTS ||--o{ INTEREST_CONFIRMATIONS : receives
    POSTING_INTERESTS ||--o{ HELP_REQUESTS : creates
    HELP_REQUESTS ||--o{ HELP_RESPONSES : receives
    HELP_REQUESTS ||--o{ HELPER_RATINGS : rated_by

    %% ========================================
    %% CHAT & MESSAGING SYSTEM
    %% ========================================
    USERS ||--o{ CONVERSATIONS : participates_in
    USERS ||--o{ MESSAGES : sends
    USERS ||--o{ USER_TYPING : indicates_typing
    USERS ||--o{ NOTIFICATIONS : receives

    CONVERSATIONS ||--o{ CONVERSATION_PARTICIPANTS : has
    CONVERSATIONS ||--o{ MESSAGES : contains
    CONVERSATIONS ||--o{ USER_TYPING : tracks_typing
    CONVERSATIONS ||--o{ POSTING_CONVERSATIONS : linked_to

    MESSAGES ||--o{ MESSAGE_ATTACHMENTS : contains
    MESSAGES ||--o{ MESSAGE_REACTIONS : has

    %% Post-Linked Conversations
    POSTINGS ||--o{ POSTING_CONVERSATIONS : initiates
    POSTING_CONVERSATIONS ||--|| CONVERSATIONS : creates

    %% ========================================
    %% MODERATION & ADMINISTRATION
    %% ========================================
    USERS ||--o{ MODERATION_DECISIONS : makes
    MODERATION_DECISIONS ||--o{ MODERATION_ACTIONS : triggers
    MODERATION_DECISIONS ||--o{ AUDIT_LOGS : logged_in

    %% Spam Detection & Analytics
    POSTINGS ||--o{ SPAM_FLAGS : flagged_as
    USERS ||--o{ USER_BLOCKS : blocked_by
    POSTINGS ||--o{ ANALYTICS_EVENTS : tracked_in

    %% ========================================
    %% ANALYTICS & REPORTING
    %% ========================================
    POSTINGS ||--o{ POSTING_ANALYTICS : analyzed_in
    USERS ||--o{ USER_ANALYTICS : tracked_in
    CONVERSATIONS ||--o{ CONVERSATION_ANALYTICS : analyzed_in
    ANALYTICS_EVENTS ||--o{ ANALYTICS_REPORTS : generates

    %% ========================================
    %% CURRENT SCHEMA ENTITY DEFINITIONS
    %% ========================================

    %% Alumni Members (Source Data from CSV)
    ALUMNI_MEMBERS {
        int id PK
        varchar student_id UK
        varchar first_name
        varchar last_name
        varchar email
        int graduation_year
        varchar degree
        varchar department
        varchar phone
        text address
        timestamp created_at
        timestamp updated_at
        INDEX idx_email (email)
        INDEX idx_student_id (student_id)
    }

    %% App Users (Authenticated Platform Users)
    USERS {
        int id PK
        varchar email UK
        varchar password_hash
        enum status "active,inactive,suspended"
        int invitation_id FK
        timestamp created_at
        timestamp updated_at
        INDEX idx_email (email)
        INDEX idx_invitation_id (invitation_id)
    }

    %% User Profiles (Extended Information)
    USER_PROFILES {
        int id PK
        int user_id FK
        int alumni_member_id FK
        varchar first_name
        varchar last_name
        varchar display_name
        text bio
        varchar avatar_url
        varchar phone
        json social_links
        timestamp created_at
        timestamp updated_at
        INDEX idx_user_id (user_id)
        INDEX idx_alumni_member_id (alumni_member_id)
    }

    %% ========================================
    %% INVITATION & AUTHENTICATION SYSTEM
    %% ========================================

    %% Core Invitation System
    USER_INVITATIONS {
        char id PK "UUID"
        varchar email
        varchar invitation_token UK
        char invited_by FK "UUID"
        enum invitation_type "alumni,family_member,admin"
        json invitation_data
        enum status "pending,accepted,expired,revoked"
        timestamp sent_at
        timestamp expires_at
        boolean is_used
        timestamp used_at
        char accepted_by FK "UUID"
        varchar ip_address
        int resend_count
        timestamp last_resent_at
        timestamp created_at
        timestamp updated_at
        json token_payload "HMAC token payload"
        varchar token_signature "HMAC-SHA256 signature"
        varchar token_format "legacy,hmac"
        INDEX idx_invitation_token (invitation_token)
        INDEX idx_email (email)
        INDEX idx_status (status)
        INDEX idx_expires_at (expires_at)
        INDEX idx_invited_by (invited_by)
        INDEX idx_token_signature (token_signature)
    }

    %% OTP Authentication System
    OTP_TOKENS {
        char id PK "UUID"
        varchar email
        varchar otp_code
        enum token_type "login,registration,password_reset"
        char user_id FK "UUID"
        timestamp generated_at
        timestamp expires_at
        boolean is_used
        timestamp used_at
        varchar ip_address
        int attempt_count
        timestamp last_attempt_at
        timestamp created_at
        INDEX idx_email_type (email, token_type)
        INDEX idx_otp_code (otp_code)
        INDEX idx_expires_at (expires_at)
        INDEX idx_user_id (user_id)
    }

    %% Family Invitation System
    FAMILY_INVITATIONS {
        char id PK "UUID"
        varchar parent_email
        json children_profiles
        varchar invitation_token UK
        enum status "pending,partially_accepted,completed"
        timestamp sent_at
        timestamp expires_at
        json acceptance_log
        char invited_by FK "UUID"
        timestamp created_at
        timestamp updated_at
        INDEX idx_family_token (invitation_token)
        INDEX idx_parent_email (parent_email)
        INDEX idx_status (status)
        INDEX idx_expires_at (expires_at)
    }

    %% COPPA Compliance - Age Verification
    AGE_VERIFICATION {
        char id PK "UUID"
        char user_id FK "UUID"
        date birth_date
        int age_at_registration
        boolean requires_parent_consent
        boolean parent_consent_collected
        varchar parent_email
        timestamp consent_timestamp
        varchar consent_ip_address
        enum verification_method "self_reported,document_verified"
        timestamp created_at
        timestamp updated_at
        INDEX idx_user_id (user_id)
        INDEX idx_requires_consent (requires_parent_consent)
        INDEX idx_parent_email (parent_email)
    }

    %% Parent Consent Records
    PARENT_CONSENT_RECORDS {
        char id PK "UUID"
        char child_user_id FK "UUID"
        varchar parent_email
        varchar consent_token UK
        boolean consent_given
        timestamp consent_timestamp
        varchar consent_ip_address
        text consent_user_agent
        text digital_signature
        timestamp expires_at
        boolean is_active
        timestamp created_at
        timestamp updated_at
        INDEX idx_child_user_id (child_user_id)
        INDEX idx_parent_email (parent_email)
        INDEX idx_consent_token (consent_token)
        INDEX idx_expires_at (expires_at)
    }

    %% Email Delivery Tracking
    EMAIL_DELIVERY_LOG {
        char id PK "UUID"
        enum email_type "invitation,otp,family_invitation,parent_consent"
        varchar recipient_email
        varchar subject
        varchar template_id
        enum delivery_status "pending,sent,delivered,failed,bounced"
        varchar external_message_id
        timestamp sent_at
        timestamp delivered_at
        text error_message
        int retry_count
        timestamp last_retry_at
        timestamp created_at
        INDEX idx_email_type (email_type)
        INDEX idx_recipient_email (recipient_email)
        INDEX idx_delivery_status (delivery_status)
        INDEX idx_sent_at (sent_at)
    }

    %% Invitation Audit Trail
    INVITATION_AUDIT_LOG {
        char id PK "UUID"
        char invitation_id FK "UUID"
        enum action "created,sent,resent,accepted,expired,revoked"
        char performed_by FK "UUID"
        varchar ip_address
        text user_agent
        json additional_data
        timestamp timestamp
        INDEX idx_invitation_id (invitation_id)
        INDEX idx_action (action)
        INDEX idx_performed_by (performed_by)
        INDEX idx_timestamp (timestamp)
    }

    %% Modified USERS table (additional columns)
    USERS {
        ...existing_columns...
        char invitation_id FK "UUID"
        boolean requires_otp
        timestamp last_otp_sent
        int daily_otp_count
        date last_otp_reset_date
        boolean age_verified
        boolean parent_consent_required
        boolean parent_consent_given
        INDEX idx_invitation_id (invitation_id)
        INDEX idx_requires_otp (requires_otp)
        INDEX idx_age_verified (age_verified)
        INDEX idx_parent_consent_required (parent_consent_required)
    }

    %% ========================================
    %% LEGACY TABLES (DEPRECATED)
    %% ========================================
    %% Note: The following tables exist in the old schema but are
    %% being phased out in favor of the clean separation above.
    %% They will be migrated/removed in future phases.

    %% Sessions and Audit (Basic Implementation)
    USER_SESSIONS {
        int id PK
        int user_id FK
        varchar session_token UK
        timestamp expires_at
        varchar ip_address
        varchar user_agent
        timestamp created_at
    }

    AUDIT_LOGS {
        int id PK
        int user_id FK
        varchar action
        varchar resource_type
        int resource_id
        json old_values
        json new_values
        varchar ip_address
        varchar user_agent
        timestamp created_at
    }

    %% User Preferences (Basic Implementation)
    USER_PREFERENCES {
        int id PK
        int user_profile_id FK
        json preferences
        timestamp created_at
        timestamp updated_at
    }