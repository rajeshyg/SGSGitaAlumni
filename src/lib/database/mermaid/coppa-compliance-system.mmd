erDiagram
    %% ========================================
    %% COPPA COMPLIANCE & AGE VERIFICATION SYSTEM
    %% ========================================
    %% Comprehensive diagram showing COPPA compliance implementation

    %% ========================================
    %% CORE COPPA ENTITIES
    %% ========================================

    %% Users and Age Verification (Central Entity)
    USERS {
        char id PK "UUID"
        varchar email UK
        varchar password_hash
        enum status "active,inactive,suspended"
        boolean age_verified
        boolean parent_consent_required
        boolean parent_consent_given
        date birth_date
        timestamp created_at
        timestamp updated_at
        INDEX idx_age_verified (age_verified)
        INDEX idx_parent_consent_required (parent_consent_required)
    }

    %% Age Verification Records (Detailed Age Information)
    AGE_VERIFICATION {
        char id PK "UUID"
        char user_id FK "UUID"
        date birth_date
        int age_at_registration
        boolean requires_parent_consent
        boolean parent_consent_collected
        varchar parent_email
        timestamp consent_timestamp
        varchar consent_ip_address
        enum verification_method "self_reported,document_verified"
        timestamp created_at
        timestamp updated_at
        INDEX idx_user_id (user_id)
        INDEX idx_requires_consent (requires_parent_consent)
        INDEX idx_parent_email (parent_email)
    }

    %% Parent Consent Management
    PARENT_CONSENT_RECORDS {
        char id PK "UUID"
        char child_user_id FK "UUID"
        varchar parent_email
        varchar consent_token UK
        boolean consent_given
        timestamp consent_timestamp
        varchar consent_ip_address
        text consent_user_agent
        text digital_signature
        timestamp expires_at
        boolean is_active
        timestamp created_at
        timestamp updated_at
        INDEX idx_child_user_id (child_user_id)
        INDEX idx_parent_email (parent_email)
        INDEX idx_consent_token (consent_token)
        INDEX idx_expires_at (expires_at)
    }

    %% ========================================
    %% RELATED SUPPORTING ENTITIES
    %% ========================================

    %% Family Invitation Integration
    FAMILY_INVITATIONS {
        char id PK "UUID"
        varchar parent_email
        json children_profiles
        varchar invitation_token UK
        enum status "pending,partially_accepted,completed"
        timestamp sent_at
        timestamp expires_at
        json acceptance_log
        char invited_by FK "UUID"
        timestamp created_at
        timestamp updated_at
        INDEX idx_parent_email (parent_email)
        INDEX idx_status (status)
    }

    %% OTP Integration for Parental Consent
    OTP_TOKENS {
        char id PK "UUID"
        varchar email
        varchar otp_code
        enum token_type "login,registration,password_reset"
        char user_id FK "UUID"
        timestamp generated_at
        timestamp expires_at
        boolean is_used
        timestamp used_at
        varchar ip_address
        int attempt_count
        timestamp last_attempt_at
        timestamp created_at
        INDEX idx_email_type (email, token_type)
        INDEX idx_user_id (user_id)
    }

    %% ========================================
    %% RELATIONSHIPS & DEPENDENCIES
    %% ========================================

    %% Primary Relationships
    USERS ||--o{ AGE_VERIFICATION : "has_verification"
    USERS ||--o{ PARENT_CONSENT_RECORDS : "child_in"
    PARENT_CONSENT_RECORDS ||--o{ USERS : "parent_consents_for"

    %% Integration Relationships
    USERS ||--o{ FAMILY_INVITATIONS : "invited_by"
    FAMILY_INVITATIONS ||--o{ USERS : "creates_multiple"
    USERS ||--o{ OTP_TOKENS : "generates"
    OTP_TOKENS ||--o{ USERS : "for_user"

    %% ========================================
    %% COPPA COMPLIANCE WORKFLOW
    %% ========================================
    %% 1. User Registration → Age Verification Check
    %% 2. If Age < 13 → Parent Consent Required
    %% 3. Parent Email Verification → Consent Collection
    %% 4. Annual Consent Renewal → Re-verification
    %% 5. Family Invitations → Multiple Child Management
    %% 6. Audit Trail → Compliance Reporting

    %% ========================================
    %% COMPLIANCE FEATURES
    %% ========================================
    %% - Age-based access control
    %% - Parental consent management
    %% - Annual consent renewal tracking
    %% - Digital signature collection
    %% - IP address logging for compliance
    %% - User agent tracking for verification
    %% - Automated consent expiration
    %% - Family relationship mapping
    %% - Comprehensive audit trails