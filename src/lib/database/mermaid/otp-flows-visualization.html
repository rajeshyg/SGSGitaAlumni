<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTP Authentication Flows - SGS Gita Alumni</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 1em;
            font-weight: 500;
            color: #495057;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .nav-tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .diagram-container {
            padding: 30px;
            display: none;
        }

        .diagram-container.active {
            display: block;
        }

        .diagram-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .diagram-description {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .mermaid {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .info-box h3 {
            color: #1976D2;
            margin-bottom: 10px;
        }

        .info-box ul {
            margin-left: 20px;
        }

        .info-box li {
            margin: 5px 0;
        }

        footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            color: #6c757d;
            border-top: 1px solid #dee2e6;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            .nav-tab {
                padding: 12px 15px;
                font-size: 0.9em;
            }

            .diagram-container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîê OTP Authentication Flows</h1>
            <p class="subtitle">Comprehensive Flow Diagrams for One-Time Password System</p>
        </header>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showDiagram('generation')">OTP Generation</button>
            <button class="nav-tab" onclick="showDiagram('validation')">OTP Validation</button>
            <button class="nav-tab" onclick="showDiagram('lifecycle')">OTP Lifecycle</button>
            <button class="nav-tab" onclick="showDiagram('admin')">Admin Display</button>
            <button class="nav-tab" onclick="showDiagram('auth')">Complete Auth Flow</button>
            <button class="nav-tab" onclick="showDiagram('ratelimit')">Rate Limiting</button>
            <button class="nav-tab" onclick="showDiagram('cleanup')">Cleanup Process</button>
            <button class="nav-tab" onclick="showDiagram('errors')">Error Handling</button>
        </div>

        <!-- OTP Generation Flow -->
        <div id="generation" class="diagram-container active">
            <h2 class="diagram-title">OTP Generation Flow</h2>
            <div class="diagram-description">
                <p>This diagram shows the complete process of generating and sending an OTP code to a user, including rate limiting checks, database storage, and email delivery.</p>
            </div>
            <div class="mermaid">
graph TD
    A[User requests OTP] --> B{Check rate limits}
    B -->|Exceeded hourly limit| C[Return 429 error]
    B -->|Exceeded daily limit| D[Return 429 error]
    B -->|Within limits| E[Generate 6-digit OTP]
    E --> F[Calculate expiry time]
    F --> G[Get user ID if exists]
    G --> H[Insert into OTP_TOKENS table]
    H --> I{Email service available?}
    I -->|Yes| J[Send OTP via email]
    I -->|No| K[Log email error]
    J --> L[Return success response]
    K --> L
    L --> M{Development mode?}
    M -->|Yes| N[Log OTP to console]
    M -->|No| O[End]
    N --> O
            </div>
            <div class="info-box">
                <h3>Key Points</h3>
                <ul>
                    <li><strong>Rate Limits:</strong> 3 OTPs per hour, 10 per day per email</li>
                    <li><strong>Expiry:</strong> Default 5 minutes (configurable via OTP_EXPIRY_MINUTES)</li>
                    <li><strong>Email Errors:</strong> OTP is still generated even if email fails</li>
                    <li><strong>Development Mode:</strong> OTP code logged to console for testing</li>
                </ul>
            </div>
        </div>

        <!-- OTP Validation Flow -->
        <div id="validation" class="diagram-container">
            <h2 class="diagram-title">OTP Validation Flow</h2>
            <div class="diagram-description">
                <p>This diagram illustrates the validation process when a user submits an OTP code, including all security checks and error conditions.</p>
            </div>
            <div class="mermaid">
graph TD
    V1[User submits OTP code] --> V2{Validate input}
    V2 -->|Invalid| V3[Return 400 error]
    V2 -->|Valid| V4[Query OTP_TOKENS table]
    V4 --> V5{OTP found?}
    V5 -->|No| V6[Return invalid OTP error]
    V5 -->|Yes| V7{Check expiration}
    V7 -->|Expired| V8[Return expired error]
    V7 -->|Valid| V9{Check if used}
    V9 -->|Already used| V10[Return already used error]
    V9 -->|Not used| V11{Check attempt count}
    V11 -->|Max attempts exceeded| V12[Return locked error]
    V11 -->|Within limits| V13{Verify OTP code}
    V13 -->|Incorrect| V14[Increment attempt count]
    V14 --> V15[Return invalid code error]
    V13 -->|Correct| V16[Mark OTP as used]
    V16 --> V17[Update used_at timestamp]
    V17 --> V18[Return validation success]
            </div>
            <div class="info-box">
                <h3>Security Features</h3>
                <ul>
                    <li><strong>Attempt Tracking:</strong> Maximum 3 validation attempts per OTP</li>
                    <li><strong>Expiration Check:</strong> OTP must be used within expiry window</li>
                    <li><strong>Single Use:</strong> OTP cannot be reused after successful validation</li>
                    <li><strong>Lockout Protection:</strong> Account locked after max attempts exceeded</li>
                </ul>
            </div>
        </div>

        <!-- OTP Lifecycle -->
        <div id="lifecycle" class="diagram-container">
            <h2 class="diagram-title">OTP Token Lifecycle</h2>
            <div class="diagram-description">
                <p>This diagram shows the complete lifecycle of an OTP token from creation to deletion.</p>
            </div>
            <div class="mermaid">
graph LR
    L1[Created] --> L2[Active]
    L2 --> L3{Status?}
    L3 -->|Used successfully| L4[Used]
    L3 -->|Time expired| L5[Expired]
    L3 -->|Max attempts| L6[Locked]
    L4 --> L7[Cleanup eligible]
    L5 --> L7
    L6 --> L7
    L7 --> L8[Deleted by cleanup job]
            </div>
            <div class="info-box">
                <h3>Lifecycle States</h3>
                <ul>
                    <li><strong>Created:</strong> OTP generated and stored in database</li>
                    <li><strong>Active:</strong> OTP is valid and can be used for authentication</li>
                    <li><strong>Used:</strong> OTP successfully validated and marked as used</li>
                    <li><strong>Expired:</strong> OTP passed expiry time without being used</li>
                    <li><strong>Locked:</strong> OTP exceeded maximum validation attempts</li>
                    <li><strong>Cleanup Eligible:</strong> OTP ready for deletion (24 hours after use/expiry)</li>
                </ul>
            </div>
        </div>

        <!-- Admin OTP Display -->
        <div id="admin" class="diagram-container">
            <h2 class="diagram-title">Admin OTP Display Workflow</h2>
            <div class="diagram-description">
                <p>This diagram shows how administrators can view active OTP codes for testing and support purposes.</p>
            </div>
            <div class="mermaid">
graph TD
    AD1[Admin views invitation section] --> AD2[Enter email address]
    AD2 --> AD3[Click Check Active OTP]
    AD3 --> AD4[Call GET /api/otp/active/:email]
    AD4 --> AD5{Active OTP exists?}
    AD5 -->|No| AD6[Show No active OTP message]
    AD5 -->|Yes| AD7[Display OTP code]
    AD7 --> AD8[Display expiry time]
    AD8 --> AD9{Check expiry status}
    AD9 -->|Expires soon| AD10[Show warning badge]
    AD9 -->|Normal| AD11[Show info badge]
    AD10 --> AD12[Disable generate button]
    AD11 --> AD12
    AD6 --> AD13[Enable generate button]
            </div>
            <div class="info-box">
                <h3>Admin Features</h3>
                <ul>
                    <li><strong>Active OTP Display:</strong> View current valid OTP for any email</li>
                    <li><strong>Expiry Status:</strong> Visual indicators for expiring OTPs</li>
                    <li><strong>Smart UI:</strong> Generate button disabled when active OTP exists</li>
                    <li><strong>Testing Support:</strong> Helps admins test invitation flows</li>
                </ul>
            </div>
        </div>

        <!-- Complete Authentication Flow -->
        <div id="auth" class="diagram-container">
            <h2 class="diagram-title">Complete Authentication Flow with OTP</h2>
            <div class="diagram-description">
                <p>This diagram shows the end-to-end authentication process from login to dashboard access using OTP verification.</p>
            </div>
            <div class="mermaid">
graph TD
    AUTH1[User enters email on login page] --> AUTH2[Click Send OTP]
    AUTH2 --> AUTH3{Check daily limit}
    AUTH3 -->|Exceeded| AUTH4[Show limit error]
    AUTH3 -->|OK| AUTH5{Check hourly rate}
    AUTH5 -->|Exceeded| AUTH6[Show rate limit error]
    AUTH5 -->|OK| AUTH7[Generate OTP]
    AUTH7 --> AUTH8[Send OTP email]
    AUTH8 --> AUTH9[Navigate to verification page]
    AUTH9 --> AUTH10[User enters OTP code]
    AUTH10 --> AUTH11[Submit for validation]
    AUTH11 --> AUTH12{OTP valid?}
    AUTH12 -->|No| AUTH13{Attempts remaining?}
    AUTH13 -->|Yes| AUTH14[Show error, allow retry]
    AUTH13 -->|No| AUTH15[Lock account, show error]
    AUTH14 --> AUTH10
    AUTH12 -->|Yes| AUTH16[Call login API with otpVerified=true]
    AUTH16 --> AUTH17[Backend skips password check]
    AUTH17 --> AUTH18[Generate JWT tokens]
    AUTH18 --> AUTH19[Update auth context]
    AUTH19 --> AUTH20[Navigate to dashboard]
            </div>
            <div class="info-box">
                <h3>Authentication Steps</h3>
                <ul>
                    <li><strong>Step 1:</strong> User requests OTP via email</li>
                    <li><strong>Step 2:</strong> System validates rate limits and generates OTP</li>
                    <li><strong>Step 3:</strong> User receives OTP via email and enters code</li>
                    <li><strong>Step 4:</strong> System validates OTP and authenticates user</li>
                    <li><strong>Step 5:</strong> JWT tokens generated and user redirected to dashboard</li>
                </ul>
            </div>
        </div>

        <!-- Rate Limiting Logic -->
        <div id="ratelimit" class="diagram-container">
            <h2 class="diagram-title">Rate Limiting Logic</h2>
            <div class="diagram-description">
                <p>This diagram illustrates the rate limiting mechanism that prevents OTP abuse and brute force attacks.</p>
            </div>
            <div class="mermaid">
graph TD
    RL1[OTP request received] --> RL2[Query OTP_TOKENS for email]
    RL2 --> RL3[Count tokens in last hour]
    RL3 --> RL4{Count >= 3?}
    RL4 -->|Yes| RL5[Return hourly limit error]
    RL4 -->|No| RL6[Count tokens in last 24 hours]
    RL6 --> RL7{Count >= 10?}
    RL7 -->|Yes| RL8[Return daily limit error]
    RL7 -->|No| RL9[Allow OTP generation]
    RL9 --> RL10[Increment counters]
            </div>
            <div class="info-box">
                <h3>Rate Limit Configuration</h3>
                <ul>
                    <li><strong>Hourly Limit:</strong> 3 OTP requests per email address</li>
                    <li><strong>Daily Limit:</strong> 10 OTP requests per email address</li>
                    <li><strong>Purpose:</strong> Prevent abuse and brute force attacks</li>
                    <li><strong>Response:</strong> HTTP 429 (Too Many Requests) when exceeded</li>
                </ul>
            </div>
        </div>

        <!-- Cleanup Process -->
        <div id="cleanup" class="diagram-container">
            <h2 class="diagram-title">OTP Cleanup Process</h2>
            <div class="diagram-description">
                <p>This diagram shows the automated cleanup process that removes expired and used OTP tokens from the database.</p>
            </div>
            <div class="mermaid">
graph TD
    CL1[Scheduled cleanup job runs] --> CL2[Query expired OTP tokens]
    CL2 --> CL3[Query used OTP tokens older than 24h]
    CL3 --> CL4[Query locked OTP tokens older than 24h]
    CL4 --> CL5[Delete all matching records]
    CL5 --> CL6[Log cleanup statistics]
    CL6 --> CL7{Errors occurred?}
    CL7 -->|Yes| CL8[Alert administrators]
    CL7 -->|No| CL9[End cleanup]
            </div>
            <div class="info-box">
                <h3>Cleanup Rules</h3>
                <ul>
                    <li><strong>Expired Tokens:</strong> Deleted immediately when detected</li>
                    <li><strong>Used Tokens:</strong> Deleted after 24 hours</li>
                    <li><strong>Locked Tokens:</strong> Deleted after 24 hours</li>
                    <li><strong>Schedule:</strong> Runs automatically via cron job or scheduled task</li>
                    <li><strong>Monitoring:</strong> Cleanup statistics logged for audit purposes</li>
                </ul>
            </div>
        </div>

        <!-- Error Handling -->
        <div id="errors" class="diagram-container">
            <h2 class="diagram-title">Error Handling Flow</h2>
            <div class="diagram-description">
                <p>This diagram shows how different types of errors are handled throughout the OTP authentication process.</p>
            </div>
            <div class="mermaid">
graph TD
    ERR1[Error occurs] --> ERR2{Error type?}
    ERR2 -->|Rate limit| ERR3[Return 429 with retry-after]
    ERR2 -->|Invalid input| ERR4[Return 400 with details]
    ERR2 -->|Not found| ERR5[Return 404 with message]
    ERR2 -->|Expired| ERR6[Return 410 with expiry info]
    ERR2 -->|Database error| ERR7[Log error, return 500]
    ERR2 -->|Email error| ERR8[Log error, continue]
    ERR3 --> ERR9[Client handles retry]
    ERR4 --> ERR10[Client shows validation error]
    ERR5 --> ERR11[Client prompts regeneration]
    ERR6 --> ERR11
    ERR7 --> ERR12[Client shows generic error]
    ERR8 --> ERR13[OTP still generated]
            </div>
            <div class="info-box">
                <h3>Error Types and Responses</h3>
                <ul>
                    <li><strong>429 Too Many Requests:</strong> Rate limit exceeded, includes retry-after header</li>
                    <li><strong>400 Bad Request:</strong> Invalid input data, includes validation details</li>
                    <li><strong>404 Not Found:</strong> OTP not found in database</li>
                    <li><strong>410 Gone:</strong> OTP expired, user must request new one</li>
                    <li><strong>500 Internal Server Error:</strong> Database or system error</li>
                    <li><strong>Email Errors:</strong> Logged but don't fail the request (OTP still generated)</li>
                </ul>
            </div>
        </div>

        <footer>
            <p><strong>SGS Gita Alumni Platform</strong> | OTP Authentication System Documentation</p>
            <p>Last Updated: October 12, 2025 | Version 1.0.0</p>
        </footer>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });

        function showDiagram(diagramId) {
            // Hide all diagrams
            document.querySelectorAll('.diagram-container').forEach(container => {
                container.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected diagram
            document.getElementById(diagramId).classList.add('active');

            // Add active class to clicked tab
            event.target.classList.add('active');
        }
    </script>
</body>
</html>

