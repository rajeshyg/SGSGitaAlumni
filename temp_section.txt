  } finally {
    connection.release();
  }

  // Generate tokens with family member context
  const tokenPayload = {
    userId: user.id,
    email: user.email,
    role: user.role,
    // Include family member context for family accounts
    activeFamilyMemberId: user.primary_family_member_id || null,
    isFamilyAccount: user.is_family_account || false
  };

  const token = jwt.sign(tokenPayload, getJwtSecret(), { expiresIn: JWT_EXPIRES_IN });
  const refreshToken = jwt.sign({ userId: user.id }, getJwtSecret(), { expiresIn: REFRESH_TOKEN_EXPIRES_IN });

  // Log token generation (without sensitive data)
  console.log('[Auth] ðŸ”‘ JWT token generated:', {
    userId: user.id,
    email: user.email,
    expiresIn: JWT_EXPIRES_IN,
    timestamp: new Date().toISOString()
  });

  // SECURITY FIX: Log success without exposing sensitive data
  logger.audit('login_success', user.id, { role: user.role, isMobile, clientIP });

  // Return user data (without password hash)
  const userResponse = {
    id: user.id,
    email: user.email,
    firstName: user.first_name || '',
    lastName: user.last_name || '',
    role: user.role,
    isActive: user.is_active,
    createdAt: user.created_at,
    is_family_account: user.is_family_account,
    family_account_type: user.family_account_type,
    primary_family_member_id: user.primary_family_member_id
  };

  res.json({
    success: true,
    token,
    refreshToken,
    user: userResponse,
